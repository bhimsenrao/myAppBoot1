name: Deploy Spring Boot to EC2

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build JAR
        run: mvn clean package -DskipTests

      - name: Copy JAR to EC2 (keeps target folder)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}   # ubuntu or ec2-user
          key: ${{ secrets.EC2_KEY }}
          source: "target/*.jar"
          target: "/home/${{ secrets.EC2_USER }}/app"

      - name: Run app from target on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            set -e

            APP_DIR="/home/${{ secrets.EC2_USER }}/app"
            TARGET_DIR="$APP_DIR/target"

            echo "Ensuring directories exist..."
            mkdir -p "$TARGET_DIR"

            echo "Listing contents of $APP_DIR:"
            ls -la "$APP_DIR" || true
            echo "Listing contents of $TARGET_DIR:"
            ls -la "$TARGET_DIR" || true

            echo "Finding JAR in target..."
            cd "$TARGET_DIR"
            JAR_FILE=$(ls *.jar | head -n 1 || true)
            if [ -z "$JAR_FILE" ]; then
              echo "No JAR found in $TARGET_DIR. Failing."
              exit 1
            fi
            echo "Using JAR: $JAR_FILE"

            echo "Killing previous app processes..."
            pkill -f "$JAR_FILE" || pkill -f 'java' || true

            echo "Setting permissions..."
            chmod 755 "$APP_DIR" || true
            chmod +x "$JAR_FILE" || true

            LOG_FILE="$APP_DIR/app.log"
            echo "Preparing log file at $LOG_FILE"
            touch "$LOG_FILE"
            chmod 644 "$LOG_FILE"

            echo "Java version on EC2:"
            java -version || { echo "Java not found on EC2"; exit 1; }

            echo "Starting app..."
            nohup java -jar "$JAR_FILE" >> "$LOG_FILE" 2>&1 &

            echo "Waiting for startup..."
            sleep 6

            echo "Process check:"
            ps -ef | grep java | grep -v grep || echo "No java process found."

            echo "Last 80 lines of log:"
            tail -n 80 "$LOG_FILE" || echo "No logs yet."
